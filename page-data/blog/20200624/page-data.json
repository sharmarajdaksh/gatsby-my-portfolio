{"componentChunkName":"component---src-templates-blog-post-jsx","path":"/blog/20200624","result":{"data":{"markdownRemark":{"html":"<p>You've probably come accross a number of application with the \"<strong>Login with Github</strong>\" option, and why not - developers love Github more than Google or Facebook. When developing your own side-projects, you often want to implement some sort of authentication or user-data management. But you really don't need to implement your own authentication services for every project - OAuth usign applications like Github does the job perfectly well. </p>\n<h2>Why should I use Github OAuth, and not my own, superior, custom authentications service?</h2>\n<p>Using Github OAuth over your own solution has several advantages:</p>\n<ul>\n<li>Github's authentication and data management approach is <em>probably</em> better than yours (please don't be offended).</li>\n<li>Convenient for users, since they won't need to manage another password.</li>\n<li>Quicker to implement (compared to your own solution). This is a very important, but perhaps neglected point for developer side projects. You don't want to spend forever on a single project (unless you really know you do).</li>\n<li>Simple to understand and implement.</li>\n</ul>\n<br/>\n<h2>Okay, I might try it. But how does it work?</h2>\n<p>Let's try to understand the authentication through the following diagram.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 536px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4c376e1b3cb4e308ba8e411f12820616/2d920/oauthflow.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAAB/UlEQVQ4y42URw/iQAyF+f//hgMHLhxAQoAQvffekUD06tVnyVFI2V1L1kwy45dn+zmR7/cr7/dbHo+HOs+Yra/XS+73u9xuN927z1ifz6ees/Ic4WC9Xkun05HBYCCfz0cPWLHZbCbNZlN9t9v9AEKk1+tJv9+X4XCo7yJ2uFqtnIteOx6PcjqdfsDc+81moywV0JiUy2Xpdrvq9XpdGRkIe2NgGbizKJVKzt2I++V2u5Xz+SyHw0FZXS4XPavVajKdTiXMIOADrFQqDm2vAVatVrXWi8VCJpOJrnwUKxQKSsQHaIy8KY1GIwWkzm43kHw+78T+FyD1Wy6XYopotVqqCJSBJ5NJuV6vv4CZTEb2+72jOxwGPNMUAtkjo2KxqHWj7tQ3kUioTn8AqQOgMM3lchqAzizl+Xwe2pRGo+FvCoCwgAFNwO1Su93WFCkDqcEGZ8+EZLNZfw2hb0XmHc4oYmhzPB7rnneAmGOUILDLVljvJJAyI2bjRgwfgDkNS6fT/qb8rcsEUxJWNMhKo7jPvX8yNGZ2Rj2RRjQalVgsJvF4XFebEGIDJyUMkJSpI4wYS4K5y6iyRxWBwg4DpE42y5zRYVIEBG0Gpszfxl1DNyCSIT2C+SjSQmI0hWalUil/UxBnGEMaYaMXZAA7DN3B3t+/e/W6adXc7v4BtjH4KjGMGUQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"OAuth Flow\"\n        title=\"OAuth Flow\"\n        src=\"/static/4c376e1b3cb4e308ba8e411f12820616/2d920/oauthflow.png\"\n        srcset=\"/static/4c376e1b3cb4e308ba8e411f12820616/772e8/oauthflow.png 200w,\n/static/4c376e1b3cb4e308ba8e411f12820616/e17e5/oauthflow.png 400w,\n/static/4c376e1b3cb4e308ba8e411f12820616/2d920/oauthflow.png 536w\"\n        sizes=\"(max-width: 536px) 100vw, 536px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>What's happening here? Let's go step by step.</p>\n<ul>\n<li>First, the client (frontend) navigates to a route designated for the github login. Say, '/login/github'</li>\n</ul>\n<br/>\n<ul>\n<li>When this route is fetched from the server (GET request to the server), the server redirects the user to a special github.com route where he can authorize the application. The route is of the form:</li>\n</ul>\n<pre><code>https://github.com/login/oauth/authorize?client_id=GITHUBCLIENTID&#x26;redirect_uri=/login/github/callback\n</code></pre>\n<p>Here, the user will login into github (if not already logged in), and on the next page, authorize the application to his information. </p>\n<br/>\n<ul>\n<li>Once the user accepts, the Github api sends a request to the redirect_uri specified in the earlier request (/login/github/callback in this case). The request gives us a <strong>code</strong> as a query parameter. We extract this code. This will be used later for getting user data.</li>\n</ul>\n<br/>\n<ul>\n<li>Next, we send a request to the GET endpoint</li>\n</ul>\n<pre><code>https://github.com/login/oauth/authorize\n</code></pre>\n<p>As query params, we send our client id and client secret (which we generate in our Github account) as well as the code we acquired in the last step. Here, at this step we can be assured that the returned data will be valid as it comes directly from Github.</p>\n<br/>\n<ul>\n<li>The above request gets us a response in the following form:</li>\n</ul>\n<pre><code>access_token=e72e16c7e42f292c6912e7710c838347ae178b4a&#x26;token_type=bearer\n</code></pre>\n<p>The server needs to extract the access_token from this request, and use it for it's final request for data.</p>\n<br/>\n<ul>\n<li>Now, the server sends a GET request to the endpoint </li>\n</ul>\n<pre><code>https://api.github.com/user \n</code></pre>\n<p>With the authorization header set</p>\n<pre><code>Authorization: token e72e16c7e42f292c6912e7710c838347ae178b4a\n</code></pre>\n<br/>\n<ul>\n<li>The response to this request is: MAGIC. No, it's the user data! That's what we wanted all along, right. No need to manage it yourself, just let Github handle enough.</li>\n</ul>\n<br/>\n<p>That was simple enough to understand, wasn't it?</p>\n<p>Let's see how you'd implement Github OAuth in your own Golang backend.</p>\n<h2>Register a Github OAuth application and initial setup</h2>\n<p>In your Github account, navigate to Settings > Developer Settings > OAuth Apps, and click on New OAuth App. </p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d7c2a6a00d14164e884ad546500add8c/8802b/oauthapp.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAAAvklEQVQY021QQQrCMBDM/8GT4NGLF28+wB+I4NmTWESxNGpj0iSbpOOmUNGSgYFld3YmG9FRD2MJWmu8mSklZPR9/8cSpppM4TxBvTWIAmKMg+HUJJfee1hnmQ6dtayLRWNhjUYjJRwLR7NR5DmMiHjm8ZJPyLtEfauZzXBVCHEIGq/iLYjcUEoN5zqufxPzS7QxCGy8OW4x2y0x36+wOKxRtQ8ESjAdz2P87onSv5RQdxKn9oKzuqJiUqLi3gfCJIV3I1jt+QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"New OAuth App\"\n        title=\"New OAuth App\"\n        src=\"/static/d7c2a6a00d14164e884ad546500add8c/5a190/oauthapp.png\"\n        srcset=\"/static/d7c2a6a00d14164e884ad546500add8c/772e8/oauthapp.png 200w,\n/static/d7c2a6a00d14164e884ad546500add8c/e17e5/oauthapp.png 400w,\n/static/d7c2a6a00d14164e884ad546500add8c/5a190/oauthapp.png 800w,\n/static/d7c2a6a00d14164e884ad546500add8c/8802b/oauthapp.png 1135w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Then, fill in the necessary details and proceed. Do note that the URL you fill in matters. I will be running my app on localhost:3000 and hence use the below URLs. Still, you can always come back and change this later (as we will do later).</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/aee9d30bce003b4c2905b95eec85cef2/d2c2a/registernewapp.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAABiElEQVQ4y5VTy3KCQBD0/78h11yS3Dzklo/wkNJKgmUUZQFZYHkvbGd2FBKrBM1WdQ1MsU33PGZN06AsS+RFwfES1fBc1zXst7cwA50sy7BzXcg4RhiG8IMAwvfheR7nhRDoug73nBNhnsMTAREdUeQlDOXazkC3HbTuOLat4Zwx02DCNK+wdA7YCQVfVhAEX9aIVAuZdYzoHC2pPWZKYUH1C4IQkYzPdTthzOZNhTlZ3rp7uPsDkiQlFR1Dty1ZvoS91JOOKqyog1EkWWEQHpGkilGQSnvRKu1xF6FSitVZ254n2O7UpbH8QFg3mpWFwqdxCREnCmXd0Ow1V2s25EYtVxXNYEJEKVlNuY62UUplZPOPxWukV8eGLH+u11hvNvhwHGy+t/wD2xRjfuvXj8xkDVk4TYfJqeAlvRUGKsmoQRJSVTR/GkelkWQVbVQORdBaTytc+Cs8LF7w+D6n+AxHurSXQEMKG9qQetiWlsn6bo8SLiMHT6tXzL/eOG5Tu7t2Gwz+e34AHZtFAfcsiMUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Register New App\"\n        title=\"Register New App\"\n        src=\"/static/aee9d30bce003b4c2905b95eec85cef2/5a190/registernewapp.png\"\n        srcset=\"/static/aee9d30bce003b4c2905b95eec85cef2/772e8/registernewapp.png 200w,\n/static/aee9d30bce003b4c2905b95eec85cef2/e17e5/registernewapp.png 400w,\n/static/aee9d30bce003b4c2905b95eec85cef2/5a190/registernewapp.png 800w,\n/static/aee9d30bce003b4c2905b95eec85cef2/d2c2a/registernewapp.png 929w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>You should now be able to acquire a Client ID and Client Secret. In your project directory, create a .env file, and store in it these values in the form below. (P.S. - Do not forget to add .env to your .gitignore file if you intend to push this project to version control later).</p>\n<pre><code>CLIENT_ID=xxxxxxxxxxxxxxxxxxxx\nCLIENT_SECRET=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n</code></pre>\n<p>There we go. We are now setup and ready to code the implementation!</p>\n<h2>Implementing authentication with a Go backend</h2>\n<p><strong>Disclaimer before we continue</strong>: If you are proceeding to read beyond here, I am hoping you have some basic understanding of how Go code is structured, and the basics of it's functioning and working principles (like, for example, how Go does not do any JS-like magic for us). Still, even if you don't, you might want to continue to be able to get a basic gist of how OAuth is actually implemented. I hope my comments and explanations will help you for the same! Let's start. </p>\n<p>Before we continue, let me clarify that I did go back and change the URLs in my GIthub OAuth page to the following:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 623px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5bbeaee5e7cd8fc84f1e6025aa11ee58/6114d/updatedappurls.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 82.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAACJ0lEQVQ4y41UTY+UQBTk53o30Xjzpgc1Jnram4n+DC9+HDyY/QFqsjvDTMMwAwzQ0EAPZb3HsuLO7GgnFZqv4lW9egQ/fv7CMgwV67XB0Pc4DINi+A/Imu+DZLuDiRO4toc/DOj9QdH1Ao+26/+CI+R6lhewtj4m3CRb7HYZ8n2JbF9gl2bY7lJkWc5rhb6sFR8OMwzw3uv+iDCOYyQkjTcbNNZi4EM9ZcsLAj6Oc2simlYQrta4XiyxNjFSVtU4x4qgVcjRiwWs8hT8qQpXJlIyQbgyWEcxbN0oitKibpzK7vp+Bp53vX7siDDP9xCUlSVBST/Tm/NK/Wya5qS0W8njzT+SrxYLRPRRvDSRVGtuv3yfT/Pr8+jceGhGucyg7K+uF9iysikyc1lzklNko+SixL6oKLfisdT4iHzxzhIVs3Y3HmcJbV2jIJGgVgKrJCU/kNFL8dS17b3Sj2IjkQk5dlG8YXwWHMEV1oyS77qTfv1rBIMlXxbvRg8lk+FIaqRJo7cVO36YBb7XGHnN6t1KA8MJMexwlCSIiRU7vdHJESQwSQ6TOmyLDnEuaDWfMpaj54Vm8rZCDdI0YQL676UCP4bZ8Z6lestNRZQNu992cJwo51rUHACpfJIePPj4FI+/vMSjzy/w8NNzPPn6ClVdocv2cBxFx6a0bM7U6XMzrYTPvl3gzeV7vL38gNff3+nRNpZEOWr+2uqESHP+0rwOxLmmyPoNIpsjkwWODusAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Updated App URLs\"\n        title=\"Updated App URLs\"\n        src=\"/static/5bbeaee5e7cd8fc84f1e6025aa11ee58/6114d/updatedappurls.png\"\n        srcset=\"/static/5bbeaee5e7cd8fc84f1e6025aa11ee58/772e8/updatedappurls.png 200w,\n/static/5bbeaee5e7cd8fc84f1e6025aa11ee58/e17e5/updatedappurls.png 400w,\n/static/5bbeaee5e7cd8fc84f1e6025aa11ee58/6114d/updatedappurls.png 623w\"\n        sizes=\"(max-width: 623px) 100vw, 623px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Inside your project directory run </p>\n<pre><code class=\"language-bash\">go mod init github.com/sharmarajdaksh/github-oauth-go\n</code></pre>\n<p>Of course, replace the github username and reponame with your own.</p>\n<p>Now, create main.go and let's start with the necessary packages and imports.</p>\n<pre><code class=\"language-go\">package main\n\nimport (\n    \"bytes\"\n    \"encoding/json\"\n    \"fmt\"\n    \"io/ioutil\"\n    \"log\"\n    \"net/http\"\n    \"os\"\n\n    \"github.com/joho/godotenv\"\n)\n</code></pre>\n<p>We define an init() function, which will automatically execute before the main function. Inside it, we will simply load up the environment variables from the .env file we created earlier. If it doesn't exist, the code panics.</p>\n<pre><code class=\"language-go\">func init() {\n    // loads values from .env into the system\n    if err := godotenv.Load(); err != nil {\n        log.Fatal(\"No .env file found\")\n    }\n}\n</code></pre>\n<p>In out main function, we'll set up our server to listen on port 3000. We define 4 routes: '/', '/auth/github', '/auth/github/callback', and '/loggedin'. Their purpose should be self explanatory. Let's see main().</p>\n<pre><code class=\"language-go\">func main() {\n\n    // Simply returns a link to the login route\n    http.HandleFunc(\"/\", rootHandler)\n\n    // Login route\n    http.HandleFunc(\"/login/github/\", githubLoginHandler)\n\n    // Github callback\n    http.HandleFunc(\"/login/github/callback\", githubCallbackHandler)\n\n    // Route where the authenticated user is redirected to\n    http.HandleFunc(\"/loggedin\", func(w http.ResponseWriter, r *http.Request) {\n        loggedinHandler(w, r, \"\")\n    })\n\n    fmt.Println(\"[ UP ON PORT 3000 ]\")\n    log.Panic(\n        http.ListenAndServe(\":3000\", nil),\n    )\n}\n</code></pre>\n<p>Each HandleFunc() call requires a Handler as the second argument. We'll see their implementation below. Interesting here is the HandleFunc for the '/loggedin' route. We implement it differently simply to allow us to pass data to the handler from elsewhere (as we will later). The actual loggedinHandler is simple:</p>\n<pre><code class=\"language-go\">func loggedinHandler(w http.ResponseWriter, r *http.Request, githubData string) {\n    if githubData == \"\" {\n        // Unauthorized users get an unauthorized message\n        fmt.Fprintf(w, \"UNAUTHORIZED!\")\n        return\n    }\n\n    // Set return type JSON\n    w.Header().Set(\"Content-type\", \"application/json\")\n\n    // Prettifying the json\n    var prettyJSON bytes.Buffer\n    // json.indent is a library utility function to prettify JSON indentation\n    parserr := json.Indent(&#x26;prettyJSON, []byte(githubData), \"\", \"\\t\")\n    if parserr != nil {\n        log.Panic(\"JSON parse error\")\n    }\n\n    // Return the prettified JSON as a string\n    fmt.Fprintf(w, string(prettyJSON.Bytes()))\n}\n</code></pre>\n<p>All we do here is return prettified JSON data which is passed to it from elsewhere if provided, otherwise it returns an unauthorized message.</p>\n<p>The rootHandler is even simpler: It merely returns an anchor tag linking to '/login/github'.</p>\n<pre><code class=\"language-go\">func rootHandler(w http.ResponseWriter, r *http.Request) {\n    fmt.Fprintf(w, `&#x3C;a href=\"/login/github/\">LOGIN&#x3C;/a>`)\n}\n</code></pre>\n<p>Before proceeding with the actual implementation of OAuth login, we define two utility functions that simply return the client id and client secret environment variables. As an alternative to this, you may have had these as global variables, and that's a perfectly acceptable approach.</p>\n<pre><code class=\"language-go\">func getGithubClientID() string {\n\n    githubClientID, exists := os.LookupEnv(\"CLIENT_ID\")\n    if !exists {\n        log.Fatal(\"Github Client ID not defined in .env file\")\n    }\n\n    return githubClientID\n}\n\nfunc getGithubClientSecret() string {\n\n    githubClientSecret, exists := os.LookupEnv(\"CLIENT_SECRET\")\n    if !exists {\n        log.Fatal(\"Github Client ID not defined in .env file\")\n    }\n\n    return githubClientSecret\n}\n</code></pre>\n<p>Now, let's look into our githubLoginHandler which handles the /login/github route.</p>\n<pre><code class=\"language-go\">func githubLoginHandler(w http.ResponseWriter, r *http.Request) {\n    // Get the environment variable\n    githubClientID := getGithubClientID()\n\n    // Create the dynamic redirect URL for login\n    redirectURL := fmt.Sprintf(\"https://github.com/login/oauth/authorize?client_id=%s&#x26;redirect_uri=%s\", githubClientID, \"http://localhost:3000/login/github/callback\")\n\n    http.Redirect(w, r, redirectURL, 301)\n}\n</code></pre>\n<p>Very simple, isn't it? We just redirect the user to another URL, and forget about it. That is all this handler needs to do. These URLs should probably have not been hardcoded, but for this small example, let's accept them as they are. Implementing this method means that when the user visits '/login/github', they should see the Github login screen or the authorize app page.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 528px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e6ef9da00af72daebb3f1abd0bc5c354/4af8e/logintogithub.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 159%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAgCAYAAAASYli2AAAACXBIWXMAAAsSAAALEgHS3X78AAADQElEQVRIx6VVTW/TQBDtX+MXINEDEggQIHGqVDgAhV6QOKAKceGIeu+BQ0/0WkRBgGgLqEWg0ObLSZrYieM4/lyv/ZixndTOh2nB0svs7uy+fZmdnV3wfR/z4HkepJSwLCtuCyFiW7RmoYgsCAJomoaNjQ1sb2/nfHMJR87JSdznr1QqYWtrC5ubmxgOh1MqPbaZ/kKezEuchOyiTqcDXddjxZ53OsefISanMIGfIDPGcRyRJeNZ5ElzhEIECMOIEKaIYkjhQwYCYZT1hZCEQoWsYvKLhiqi1gEitYTIt0ajyS9tcCZCnshLooCUlT+i+/ISzNcriIwG+RI/k56PMEpUiIM30J5dQP/VNcBQxv5zK+RPyhDC1BD0qvDUMhzTQOoab3pmQg56tVZDrd5Ao9nEz18l7O1/w0m7c37CMJToUd4pdQXlSjXOQyYv/T7CweEPdHt6Oi86/ylPfhyGkbozKeRCYBgGYQDLttO2Ab3fj69eLqXOQthRVSiNJG5atwdFUQgNVGp1NFsnscIEMo5zISFPZKtqvZisRiR635hM9TESQlGs0LYtDAYDmATh85WjuEZ01UiRYQuYTkA2QN8K4AfhVPWZIlRaKkoVBUe1JmwRwZOAI0JYXohj1Uep4ye27WPgcNGYQTiqaa6QqGoOKk0V5aaGI6WNekeHSWQDV9IGBF/SBpLGJLqWJIUFMfSp2tgu4BFctl5ibbYEmjYG+xwem0XoUWF1yYZ0KGu/17H45S6u7T/Clb0HuPF1FfcO13Dn+5O4f3XvIa6T7+LnJbzr7lJ2M7Ezn/D54Touv13GzfcruL5zH7c/PMbq7gssf3qKGzsPYtwi3+L2Enbau/GBO64z/03hHTOZkUBi5ngURFNvUY7QpUDxbhalDt8S0xpiyKC25Tg52ASHAlz4BLhpu9lqoZHellqtipOuiXLbRl2zoRCOTyhXLTfOUxZRSMgTErhJP32oTsfzc6YUTt7F/Ovn/RVz73LWwcnKNkgt94U/aosxsmtyCrMDNmWrMXQp8B76ZG36axwv06IDo4PgEmammKkwS8gqTFrc1p3YNrt2TM79tu7GZFyFuikKCf/3L89UmD8U758O5Q/yHpkMHu203AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Login to Github\"\n        title=\"Login to Github\"\n        src=\"/static/e6ef9da00af72daebb3f1abd0bc5c354/4af8e/logintogithub.png\"\n        srcset=\"/static/e6ef9da00af72daebb3f1abd0bc5c354/772e8/logintogithub.png 200w,\n/static/e6ef9da00af72daebb3f1abd0bc5c354/e17e5/logintogithub.png 400w,\n/static/e6ef9da00af72daebb3f1abd0bc5c354/4af8e/logintogithub.png 528w\"\n        sizes=\"(max-width: 528px) 100vw, 528px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>If the user is already logged in, or after they log in, they will see this screen:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 783px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/50524c739ffbb5d3b568d8f3a42ca3e3/e51a6/authorizeapp.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 99%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAACpUlEQVQ4y5VUW2sTQRTur/NXiA+ivgsWEW1BELwE+iAiFJ/Fd8VbFbRNq9JiW6w2xVKbNLfNZq/Zze7Ozsx+nplN1m0Siw4cTmZy9pvvnPOdmUu5gDI2sjTl5CWYyLRX+3GMWlxI7VnpvGxzxUYFaDABHgeQ1i/w0NGgUZJAZsDzl6+xePsOfuwfgLZIWHo2IEspgAjw5i6syjmI/ffoEfhy7Rlqh4d49HgZx/U67lWWNOAslgUgGzFMKTNmtxB/eQphHiGlD63YRRjF+LBaxepaFS+IKc5iOL6JjX8Ty4Bl6Ls+HNdDGEQYBEO4/gD+INBgZZAy07kCTKecG6e94zioN07QaLbR7hpodwwc016BTsaXQQuGXAhdF0nVF9TJDLNXlmU6VsUoO4Nhiu2dGoyeiS4x6lku6maEg6aHo7aHOI7BGNOA5aVkdAow5X9od7ombNtBzzRh9vvwqF7+IITrDRCGQwJNCsCxV2ynGOYHHCetFgwCazRbVLcObNfBMI4wjCJqWKrLIDJZmCSbwTC/QYwm4H/XNEOdstAMd80a1tvb+NzZJdvBZncPW8Ye+W/Y6ub+U3tH/7/e+orv/Z+aSLnbRVOSlGFx4yEuvLmOyysLuLRyC1c/3sV8tYJraw9wY2NJ7y++vYkr7xZw/tU87m8+AWV9GrBIWc5ImQOe6SGwSdB9nzT1DymXdSipc7rgkh4Iqc4ZddqH56uJcbW0lELlqCnqG/43HcZJquWhTI1ZQudBmI9cFDP6OEM4jGE7HoH7WlJqlqcmZZx/wrgG6xhKg7bW35AeBMPsw7QcWLYLPwhhOS5JqkeS8k8BTdUwT1sWlrNmxCrSTNUFKgshsyJm5iyX858c+Bww1k+X8uPnqhwzNcuTQJM3TrKe9TqVz38DYfH77E0swq4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Authorize app\"\n        title=\"Authorize app\"\n        src=\"/static/50524c739ffbb5d3b568d8f3a42ca3e3/e51a6/authorizeapp.png\"\n        srcset=\"/static/50524c739ffbb5d3b568d8f3a42ca3e3/772e8/authorizeapp.png 200w,\n/static/50524c739ffbb5d3b568d8f3a42ca3e3/e17e5/authorizeapp.png 400w,\n/static/50524c739ffbb5d3b568d8f3a42ca3e3/e51a6/authorizeapp.png 783w\"\n        sizes=\"(max-width: 783px) 100vw, 783px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Once the user accepts, a request is sent by Github to the route '/login/github/callback', which is handled by the githubCallbackHandler. It does a lot, but don't worry, we'll go through it step by step. Here is the code for the handler:</p>\n<pre><code class=\"language-go\">func githubCallbackHandler(w http.ResponseWriter, r *http.Request) {\n    code := r.URL.Query().Get(\"code\")\n\n    githubAccessToken := getGithubAccessToken(code)\n\n    githubData := getGithubData(githubAccessToken)\n\n    loggedinHandler(w, r, githubData)\n}\n</code></pre>\n<p>Believe me, it does a lot. I've just extracted major parts to the functions getGithubAccessToken and getGithubData(). Here's how it works:</p>\n<ul>\n<li>We extract the \"code\" query parameter sent by github to this route. </li>\n<li>This code is sent to getGithubAccessToken, which exchanges the code along with our github client id and secret to get an authentication token and returns it.</li>\n<li>The returned authentication token is then passed to getGithubData(), which returns the user data acquired from github.</li>\n<li>We then execute the loggedinHandler with the Request and ResponseWriter, passing the githubData as a third argument.</li>\n</ul>\n<p>The concept is simple to understand with all this abstractions, and we have now covered our handlers as they work.</p>\n<p>Now, let's see how we will implement getGithubAccessToken and getGithubData(), the functions which do the actual heavy lifting behind the scenes.</p>\n<p>The getGithubAccessToken received the code returned by Github as an argument, and is responsible to use it, along with the Github client id and client secret, to get a unique access token which will finally allow us to get the necessary user data. Let's see how this method works in code.</p>\n<pre><code class=\"language-go\">func getGithubAccessToken(code string) string {\n\n    clientID := getGithubClientID()\n    clientSecret := getGithubClientSecret()\n\n    // Set us the request body as JSON\n    requestBodyMap := map[string]string{\"client_id\": clientID, \"client_secret\": clientSecret, \"code\": code}\n    requestJSON, _ := json.Marshal(requestBodyMap)\n\n    // POST request to set URL\n    req, reqerr := http.NewRequest(\"POST\", \"https://github.com/login/oauth/access_token\", bytes.NewBuffer(requestJSON))\n    if reqerr != nil {\n        log.Panic(\"Request creation failed\")\n    }\n    req.Header.Set(\"Content-Type\", \"application/json\")\n    req.Header.Set(\"Accept\", \"application/json\")\n\n    // Get the response \n    resp, resperr := http.DefaultClient.Do(req)\n    if resperr != nil {\n        log.Panic(\"Request failed\")\n    }\n\n    // Response body converted to stringified JSON\n    respbody, _ := ioutil.ReadAll(resp.Body)\n\n    // Represents the response received from Github\n    type githubAccessTokenResponse struct {\n        AccessToken string `json:\"access_token\"`\n        TokenType   string `json:\"token_type\"`\n        Scope       string `json:\"scope\"`\n    }\n\n    // Convert stringified JSON to a struct object of type githubAccessTokenResponse\n    var ghresp githubAccessTokenResponse\n    json.Unmarshal(respbody, &#x26;ghresp)\n\n    // Return the access token (as the rest of the details are relatively unnecessary for us)\n    return ghresp.AccessToken\n}\n</code></pre>\n<p>There we have it. It's fairly simple in what it does:</p>\n<ul>\n<li>Form a JSON object that has the code, our github client id, and out client secret.</li>\n<li>Send the JSON as body for a POST request.</li>\n<li>Get the JSON response, extract from it the AccessToken, and return it (as a string).</li>\n</ul>\n<p>For people coming from, say, Javascript/Nodejs, you might be thinking- this could've been done in 10 lines of Javascript. I don't disagree. That's just how Go is. It is low level enough to not do any magic for you, but high level enough to provide extremely powerful libraries for tasks like http requests and JSON manipulation.</p>\n<p>At this point, now, we have our AccessToken. We are nearly done! The last thing we need to do is use the access token we received and to tell Github we're authorized to fetch the current user's data. This happens in getGithubData().</p>\n<pre><code class=\"language-go\">func getGithubData(accessToken string) string {\n    // Get request to a set URL\n    req, reqerr := http.NewRequest(\"GET\", \"https://api.github.com/user\", nil)\n    if reqerr != nil {\n        log.Panic(\"API Request creation failed\")\n    }\n\n    // Set the Authorization header before sending the request\n    // Authorization: token XXXXXXXXXXXXXXXXXXXXXXXXXXX\n    authorizationHeaderValue := fmt.Sprintf(\"token %s\", accessToken)\n    req.Header.Set(\"Authorization\", authorizationHeaderValue)\n\n    // Make the request\n    resp, resperr := http.DefaultClient.Do(req)\n    if resperr != nil {\n        log.Panic(\"Request failed\")\n    }\n\n    // Read the response as a byte slice\n    respbody, _ := ioutil.ReadAll(resp.Body)\n\n    // Convert byte slice to string and return\n    return string(respbody)\n}\n</code></pre>\n<p>There we are. A simple GET request gets back to us the user's data in the response body, which we may use as we like.\nIn our case, as you see in the githubCallbackHandler method, we send this data to the loggedInHandler, and this data is displayed on the '/loggedin' route. For me, it was something like this:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e045148b69de97dcba8f747d108109bd/fe238/datajson.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAABl0lEQVQ4y5WTCY+CMBSE9///OkVOQU4VjKjrDaK+7Uy2DWw0cV8yKdXydd7B136/l/P5TLVNK13XSdM0crvd5PF4yP1+52/9VQv7v/oSFXh5sVhIUeQSRZGUZSV1XcvlcuGh5/NphEs0GHuEXhEEwpFt2zKbzSSOYwUuJM9zSZKE4N1uZ3Q8Hn+fvwnuB8AGGEUhIRCgcIrV931xXZfCRSjR4XAgGGXql8E4bNtWPM+jw6qqCPODQDwFcRwFU/8B7DiOWOMxswnU3rYdmc/nst1uCR+kDAfhdCpZltIloYS4fBkXAmRZloxGY57XBtbrNWs7cIgDWZZJoWC4FfULlEvfD7hCruvRJQRYWZay2Wz4/iBlOJwqd3ChG3E6ndhlCM9aqB1qiFpqYY9JGQAdlU6aprx5uVwSer1ezcFPwnS5BVClAVAYoo45O4rZREqoT38W38k4hBPUKEliMx4otk7t1QC/CwP0fY+dBQj7V+l8EgR2qk6TyYRNqdUIrFYrgpFyfyQ+cqi/VXQPHUWDkKoWBvY/Kf8A39wtBAAzAJEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"User data\"\n        title=\"User data\"\n        src=\"/static/e045148b69de97dcba8f747d108109bd/5a190/datajson.png\"\n        srcset=\"/static/e045148b69de97dcba8f747d108109bd/772e8/datajson.png 200w,\n/static/e045148b69de97dcba8f747d108109bd/e17e5/datajson.png 400w,\n/static/e045148b69de97dcba8f747d108109bd/5a190/datajson.png 800w,\n/static/e045148b69de97dcba8f747d108109bd/c1b63/datajson.png 1200w,\n/static/e045148b69de97dcba8f747d108109bd/fe238/datajson.png 1401w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>In a real app, of course you could done something more useful with this user data: save it to a database, use it in your frontend, or anything else you want. </p>\n<p>There we have it! We've implemented Github OAuth into our application backend. The complete application code is available to view <a href=\"https://github.com/sharmarajdaksh/github-oauth-go\">here</a>.</p>\n<p>I hope you learnt something new today! The principles discussed here should be effectively transferrable to any other language backend, or even for other OAuth providers like Google or Facebook, although the documentation should be your best friend in those cases.</p>\n<p>Until next time, happy learning.</p>","frontmatter":{"title":"Github OAuth with Go","subtitle":"Because do you really need to implement your own authentication service?","date":"June 24, 2020"}}},"pageContext":{"slug":"20200624"}}}